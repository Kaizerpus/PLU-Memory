<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Offline Support</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üåê PLU Memory - Offline Support Test</h1>
    
    <div class="status info">
        <strong>üìã Test Status:</strong>
        <div id="connectionStatus">Kontrollerar anslutning...</div>
        <div id="swStatus">Kontrollerar Service Worker...</div>
        <div id="cacheStatus">Kontrollerar cache...</div>
    </div>

    <div>
        <h3>üîß Test Controls</h3>
        <button onclick="testServiceWorker()">Test Service Worker</button>
        <button onclick="testCache()">Test Cache</button>
        <button onclick="testOfflineMode()">Simulera Offline</button>
        <button onclick="clearCache()">Rensa Cache</button>
        <button onclick="openMainGame()">√ñppna Huvudspel</button>
    </div>

    <div id="log"></div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateConnectionStatus() {
            const status = navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline';
            document.getElementById('connectionStatus').textContent = status;
        }

        async function testServiceWorker() {
            log('üîß Testing Service Worker...', 'info');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    log('‚úÖ Service Worker registrerad: ' + registration.scope, 'success');
                    document.getElementById('swStatus').textContent = '‚úÖ Service Worker aktiv';
                    
                    // Check if SW is active
                    if (registration.active) {
                        log('‚úÖ Service Worker √§r aktiv och redo', 'success');
                    } else {
                        log('‚è≥ Service Worker installeras...', 'info');
                    }
                } catch (error) {
                    log('‚ùå Service Worker fel: ' + error.message, 'error');
                    document.getElementById('swStatus').textContent = '‚ùå Service Worker fel';
                }
            } else {
                log('‚ùå Service Worker st√∂ds inte', 'error');
                document.getElementById('swStatus').textContent = '‚ùå St√∂ds inte';
            }
        }

        async function testCache() {
            log('üíæ Testing Cache...', 'info');
            
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    log('üì¶ Tillg√§ngliga caches: ' + cacheNames.join(', '), 'info');
                    
                    const cache = await caches.open('plu-memory-v1');
                    const keys = await cache.keys();
                    log('üìã Cachade filer (' + keys.length + '): ' + keys.map(r => r.url.split('/').pop()).join(', '), 'success');
                    document.getElementById('cacheStatus').textContent = '‚úÖ Cache aktiv (' + keys.length + ' filer)';
                } catch (error) {
                    log('‚ùå Cache fel: ' + error.message, 'error');
                    document.getElementById('cacheStatus').textContent = '‚ùå Cache fel';
                }
            } else {
                log('‚ùå Cache API st√∂ds inte', 'error');
                document.getElementById('cacheStatus').textContent = '‚ùå St√∂ds inte';
            }
        }

        function testOfflineMode() {
            log('üì± Simulerar offline-l√§ge...', 'info');
            
            // Simulate offline
            Object.defineProperty(navigator, 'onLine', {
                writable: true,
                value: false
            });
            
            window.dispatchEvent(new Event('offline'));
            updateConnectionStatus();
            
            log('üî¥ Nu i offline-l√§ge - testa navigera till huvudspelet', 'info');
            
            // Return online after 10 seconds
            setTimeout(() => {
                Object.defineProperty(navigator, 'onLine', {
                    writable: true,
                    value: true
                });
                window.dispatchEvent(new Event('online'));
                updateConnectionStatus();
                log('üü¢ Tillbaka online', 'success');
            }, 10000);
        }

        async function clearCache() {
            log('üóëÔ∏è Rensar cache...', 'info');
            
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                log('‚úÖ Cache rensad', 'success');
                document.getElementById('cacheStatus').textContent = 'üîÑ Cache rensad';
            } catch (error) {
                log('‚ùå Fel vid rensning av cache: ' + error.message, 'error');
            }
        }

        function openMainGame() {
            window.open('./index.html', '_blank');
        }

        // Initialize
        updateConnectionStatus();
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Auto-test on load
        setTimeout(() => {
            testServiceWorker();
            setTimeout(testCache, 1000);
        }, 500);

        log('üöÄ Offline test-sida laddad', 'success');
    </script>
</body>
</html>